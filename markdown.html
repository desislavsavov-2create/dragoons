<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	
	<title>Regular Expressions</title>

	<script>
		'use strict';

		window.onload = function() {
			var regexes = {
				regexStrong: /\*(.*?)\*/g,
				regexHeadings: /^#{1,3}.*$/mg,
				regexLink: /<([^>]+)>/g,
				regexWhiteSpace: /\n|\r|\n\r|\r\n/gm,
				regexUL: /(^\s*\*\s*.*$(\n|\r|\n\r|\r\n))+/gm,
				regexOL: /(^\s*\d*\.\s*.*$(\n|\r|\n\r|\r\n))+/gm,
				regexReplaceUL: /^\s*\*\s*/gm,
				regexReplaceOL: /^\s*\d*\.\s*/gm,
				regexSimpleUL: /^\s*\*\s*/,
				regexSimpleOL: /^\s*\d\.\s*/,
				regexHR: /^-+/gm,
				regexCodeBlock: /\{{3}[\w\W]+?\}{3}/g,
				regexCode: /\`{1}[\w\W]+?\`{1}/g
			};
			var codeBlocks = {};
			
			function extractCodeBlocks( input ) {
				input = input.replace(regexes.regexCodeBlock, function(match) {
					var uniqieBlockID = '_' + Math.random() + '_' + (new Date()).getTime();

					codeBlocks[uniqieBlockID] = match;

					return uniqieBlockID;
				});

				return input;
			};

			function createCodeBlocks( input ) {
				for ( var blockID in codeBlocks ) {

					codeBlocks[blockID] = codeBlocks[blockID].replace(/\{{3}/, '').replace(/\}{3}/, '');

					if ( codeBlocks.hasOwnProperty(blockID) ) {
						input = input.replace(blockID, '<pre><code>' + codeBlocks[blockID] + '</code></pre>');
					}
				}

				return input;
			};

			function lists(input, splitRegex, listRegex, tag) {
				var lines = input.split(splitRegex);
				var isInList = false;
				var output = [];
				var line;

				for ( var i = 0; i < lines.length; i++ ) {
					line = lines[i];

					if ( listRegex.test(line) ) {
						line = '<li>' + line.replace(listRegex, '') + '</li>';

						if ( !isInList ) {
							line = '<' + tag + '>\n' + line;

							isInList = true;
						}
					} else {
						if ( isInList ) {
							line = '</' + tag + '>\n' + line;

							isInList = false;
						}
					}

					output.push(line);
				}

				return output.join('\n');
			};

			function doLinks(text) {
				text = text.replace(regexes.regexLink, '<a href="$1">$1</a>');

				return text;
			}

			function doStrongs(text) {
				text = text.replace(regexes.regexStrong, '<strong>$1</strong>');

				return text;
			}

			function doHeadings(text) {
				text = text.replace(regexes.regexHeadings, function( match ) {
					var pieces = match.match(/^(#{1,3})\s*(.*)/);
					var sharpsCount = pieces[1].length;
					var headingText = pieces[2];
					var headingTag = 'h' + sharpsCount;

					return '<' + headingTag + '>' + headingText + '</' + headingTag + '>';
				});
			}

			function doHorizonatalRules(text) {
				text = text.replace(regexes.regexHR, '<hr />');

				return text;
			}

			function parseText( text ) {
				// prepare code blocks
				text = extractCodeBlocks(text);

				// links
				doLinks(text);

				// strong
				doStrongs(text);

				// headings
				doHeadings(text);

				// unordered lists
				text = lists(text, regexes.regexWhiteSpace, regexes.regexSimpleUL, 'ul');

				// ordered lists
				text = lists(text, regexes.regexWhiteSpace, regexes.regexSimpleOL, 'ol');

				// horizontal rules
				doHorizonatalRules(text)

				// create codeblocks
				text = createCodeBlocks( text );

				return text;
			}

			document.getElementById('submit').onclick = function() {
				document.getElementById('output').innerHTML = parseText(document.forms[0].elements[0].value);
				return false;
			}
		};

	</script>
</head>
<body>
	<form action="?" method="post">
		<textarea cols="30" rows="10" style="width: 300px; height: 200px; display: block; margin: 0 auto;"></textarea>

		<input type="submit" id="submit" style="display: block; margin: 20px auto;" />
	</form>

	<div id="output" style="padding: 20px; border: 1px solid #000; margin: 20px;"></div>
</body>
</html>