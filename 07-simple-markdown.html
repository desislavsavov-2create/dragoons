<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>JS Learning - 07. Simple Markdown</title>
</head>
<body>

	<!-- SIMPLE MARKDOWN -->

	<form action="#" method="post" id="formEntry">
		<textarea name="textEntry" id="textEntry" cols="30" rows="10"></textarea>
		<button id="btn" type="submit">Parse</button>
		<button id="clear">Clear</button>
	</form>

	<div id="parsed">
		
	</div><!-- /#parsed -->

	<style>
		form { margin: 0 0 20px; }

		textarea { display: block; resize: none; }
	</style>

	<script>
		(function() {
			'use strict';
		
			window.onload = function() {
				var _form = document.getElementById('formEntry');
				var _textarea = document.getElementById('textEntry');
				var _btn = document.getElementById('btn');
				var _clear = document.getElementById('clear');

				var _parsed = document.getElementById('parsed');

				_btn.onclick = function(e) {
					e.preventDefault();

					var newContainer = document.createElement('div');

					var text = _textarea.value;

					if(text.length === 0) {
						return false;
					}

					newContainer.innerHTML = parseText(text);

					_parsed.appendChild(newContainer);
				}

				_clear.onclick = function(e) {
					e.preventDefault();

					_parsed.innerHTML = '';
					_textarea.value = '';
					console.clear();
				}
			};

			function parseText(text) {
				var replacedCodes = {};

				// Codes
				text = doCodes(text);
				text = doCodeBlocks(text);
				
				// Hide code blocks from parser

				text = hideCodes(text, 'block', replacedCodes);
				text = hideCodes(text, 'inline', replacedCodes);

				// Links
				text = doLinks(text);

				// Headings
				text = doHeadings(text);

				// Strong
				text = doStrong(text);

				// Unordered List
				text = doUnorderedList(text);

				// Ordered List
				text = doOrderedList(text);

				// Horizontal Rule
				text = doHorizontalRule(text);

				// Restore code blocks
				text = restoreCodes(text, replacedCodes);

				return text;
			}

			// Do inline codes
			function doCodes(text) {
				var regexCode = /`(.*?)`/gm;
				
				text = text.replace(regexCode, function(match) {
					var result = match.match(/`(.*?)`/);

					result = result[1].replace(/</g, '&lt;').replace(/>/g, '&gt;');

					return '<code>' + result + '</code>';
				});

				return text;
			}

			// Do code blocks
			function doCodeBlocks(text) {
				var regexCodeBlock = /\{{3}([\W\w]+?)\}{3}/gm;

				text = text.replace(regexCodeBlock, function(match) {
					var result = match.match(/\{{3}([\W\w]+?)\}{3}$/m);
					result = result[1].replace(/</g, '&lt;').replace(/>/g, '&gt;');

					return '<pre><code>' + result + '</code></pre>\n';
				});

				return text;
			}

			// Do links
			function doLinks(text) {
				var regexLink = /<((https?)?\/\/(.*?))>/g;

				text = text.replace(regexLink, '<a href="$1">$1</a>');

				return text;
			}

			// Do headings
			function doHeadings(text) {
				var regexHeadings = /^#{1,6}.*$/mg;
				
				text = text.replace(regexHeadings, function(match) {
					var pieces = match.match(/^(#{1,6})(.*)/);
					var sharpsCount = pieces[1].length;
					var headingText = pieces[2];

					return '<h' + sharpsCount + '>' + headingText + '</h' + sharpsCount + '>\n';
				});

				return text;
			}

			// Do strong
			function doStrong(text) {
				var regexStrong = /\*(\s?.*?\s?)\*/g;

				return text.replace(regexStrong, '<strong>$1</strong>');
			}

			// Do ordered and unordered lists
			function doList(text, listType) {
				var regexListType;

				if(listType === 'ul') {
					regexListType = /^ *\* */mg;
				} else if(listType === 'ol') {
					regexListType = /^ *\d+ */mg;
				}

				text = text.replace(regexListType, '');

				var matchRows = text.split(/[\n\r]/);

				var result;
				var resultRows = [];

				for( var i = 0; i < matchRows.length; i++ ) {
					if( matchRows[i].length > 0 ) {
						resultRows.push('<li>' + matchRows[i] + '</li>');
					}
				}

				result = resultRows.join('\n');

				return '<' + listType + '>' + result + '\n</' + listType + '>\n';
			}

			// Unordered lists
			function doUnorderedList(text) {
				var regexUnorderedList = /(^ *\* *.*$(\n|\r|\n\r|\r\n)?)+/mg;
				
				text = text.replace(regexUnorderedList, function(match) {
					var match = match;

					var result = doList(match, 'ul');

					return result;
				});

				return text;
			}

			// Ordered lists
			function doOrderedList(text) {
				var regexOrderedList = /(^ *\d+ *.*$(\n|\r|\n\r|\r\n)?)+/mg;

				text = text.replace(regexOrderedList, function(match) {
					var match = match;

					var result = doList(match, 'ol');

					return result;
				});

				return text;
			}

			function doHorizontalRule(text) {
				var regexHr = /^-{4,}$/mg;
				
				return text.replace(regexHr, '<hr />\n');
			}

			// Hide codes
			function hideCodes(text, codeType, codeBlocksHolder) {
				var regex;

				if(codeType === 'block') {
					regex = /<pre><code>([\w\W]+?)<\/code><\/pre>/gm;
				} else if(codeType === 'inline') {
					regex = /<code>([\w\W]+?)<\/code>/gm;
				}

				var result = text.replace(regex, function(match) {
					var codeBlockId  = 'codeStr_' + Math.random() + '__' + (new Date()).getTime();

					codeBlocksHolder[codeBlockId] = match;

					return codeBlockId;
				});

				return result;
			}

			function restoreCodes(text, codeBlocksHolder) {
				for( var codeBlockId in codeBlocksHolder) {
					if(codeBlocksHolder.hasOwnProperty(codeBlockId)) {
						text = text.replace(codeBlockId, codeBlocksHolder[codeBlockId]);
					}
				}

				return text;
			}
		})();
	</script>
</body>
</html>